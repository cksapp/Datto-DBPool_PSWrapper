name: Publish to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_run:
    workflows:
      - Build and Release
    types: [completed]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: version
        shell: pwsh
        run: |
          $tagName = "${{ github.event.release.tag_name }}"

          if (-not $tagName) {
              $sha = "${{ github.event.workflow_run.head_sha }}"
              if (-not $sha) {
                  $sha = (git rev-parse HEAD)
              }

              $tagName = git tag --points-at $sha | Where-Object { $_ -match '^v\d+\.\d+\.\d+$' } | Select-Object -First 1
          }

          if (-not $tagName) {
              Write-Error "[ERROR] Could not resolve a release tag for this run"
              exit 1
          }

          $version = $tagName -replace '^v', ''
          Write-Output "version=$version" >> $env:GITHUB_OUTPUT
          Write-Output "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          Write-Host "Release version: $version"

      - name: Download release artifact
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $tagName = "${{ steps.version.outputs.tag_name }}"
          $assetName = "Datto.DBPool.API-$version.zip"

          Write-Host "Downloading: $assetName from $tagName"
          gh release download $tagName -p $assetName -O module.zip

          if (-not (Test-Path module.zip)) {
              Write-Error "[ERROR] Module artifact not found in release: $assetName"
              exit 1
          }

          Write-Host "[SUCCESS] Downloaded successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract module archive
        shell: pwsh
        run: |
          Write-Host "Extracting module.zip..."
          Expand-Archive -Path "module.zip" -DestinationPath "." -Force

          Write-Host "Extracted contents:"
          Get-ChildItem -Recurse | Select-Object FullName

      - name: Validate module structure
        id: validate
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $modulePath = "Datto.DBPool.API/$version"

          if (-not (Test-Path $modulePath)) {
              Write-Error "[ERROR] Module directory not found: $modulePath"
              exit 1
          }

          $manifestPath = Join-Path $modulePath "Datto.DBPool.API.psd1"
          if (-not (Test-Path $manifestPath)) {
              Write-Error "[ERROR] Module manifest not found: $manifestPath"
              exit 1
          }

          Write-Output "module_path=$modulePath" >> $env:GITHUB_OUTPUT
          Write-Host "[SUCCESS] Module structure validated"
          Write-Host "Module path: $modulePath"

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          PS_GALLERY_API_KEY: ${{ secrets.PS_GALLERY_API_KEY }}
        run: |
          $modulePath = "${{ steps.validate.outputs.module_path }}"

          if (-not $env:PS_GALLERY_API_KEY) {
              Write-Error "[ERROR] PS_GALLERY_API_KEY secret is not set"
              Write-Host "Please add the secret in repository Settings > Secrets and variables > Actions"
              exit 1
          }

          Write-Host "Publishing module from: $modulePath"

          try {
              Publish-Module -Path $modulePath -NuGetApiKey $env:PS_GALLERY_API_KEY -Verbose -Force
              Write-Host "[SUCCESS] Module published successfully to PowerShell Gallery"
          } catch {
              Write-Error "[ERROR] Failed to publish module: $_"
              exit 1
          }

      - name: Trigger documentation update
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'Build_DocsSite.yml',
              ref: 'main'
            });
            core.info('[SUCCESS] Triggered documentation update after PSGallery publish');
