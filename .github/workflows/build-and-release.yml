name: Build and Release

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log and tags
      
      - name: Build in dev container
        uses: devcontainers/ci@v0.3
        with:
          runCmd: |
            pwsh -c './build.ps1 -Bootstrap'
      
      - name: Extract version from CHANGELOG
        id: version
        shell: pwsh
        run: |
          $changelogPath = './CHANGELOG.md'
          $changelogTagMatchRegEx = "^##\s\[(?<Version>(\d+\.){1,3}\d+)\]"
          $version = Get-Content $changelogPath | ForEach-Object {
              if ($_ -match $changelogTagMatchRegEx) {
                  return $matches.Version
              }
          } | Select-Object -First 1
          
          if (-not $version) {
              Write-Error "Could not extract version from CHANGELOG.md"
              exit 1
          }
          
          Write-Output "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "✅ Extracted version: $version"
      
      - name: Get previous release tag
        id: previous-tag
        shell: pwsh
        run: |
          $tag = & git describe --tags --abbrev=0 2>$null
          if ($tag) {
              Write-Output "tag=$tag" >> $env:GITHUB_OUTPUT
              Write-Host "Previous release tag: $tag"
          } else {
              Write-Output "tag=" >> $env:GITHUB_OUTPUT
              Write-Host "No previous release found (first release)"
          }
      
      - name: Validate version has changed
        shell: pwsh
        run: |
          $currentVersion = "${{ steps.version.outputs.version }}"
          $previousTag = "${{ steps.previous-tag.outputs.tag }}"
          
          if ($previousTag) {
              # Remove 'v' prefix if present for comparison
              $previousVersion = $previousTag -replace '^v', ''
              
              if ($previousVersion -eq $currentVersion) {
                  Write-Error @"
          ❌ Version has not changed since last release!
             Current version: $currentVersion
             Last released:   $previousVersion
             
             Please update the version in:
             - CHANGELOG.md (add new section with format: ## [X.Y.Z] Release)
             - src/Datto.DBPool.API.psd1 (update ModuleVersion)
             
             The Pester tests validate these match before publishing.
          "@
                  exit 1
              }
              
              Write-Host "✅ Version updated: $previousVersion → $currentVersion"
          } else {
              Write-Host "✅ First release with version: $currentVersion"
          }
      
      - name: Generate release notes
        id: release-notes
        shell: pwsh
        run: |
          $previousTag = "${{ steps.previous-tag.outputs.tag }}"
          
          if ($previousTag) {
              $notes = & git log "${previousTag}..HEAD" --pretty=format:"- %s (%h)" --no-merges
              if ($notes) {
                  $header = "## Changes since $previousTag`n`n"
                  $fullNotes = $header + ($notes -join "`n")
              } else {
                  $fullNotes = "No changes recorded"
              }
          } else {
              $fullNotes = "First release"
          }
          
          $fullNotes | Out-File -FilePath release-notes.txt -Encoding utf8
          Write-Host "Release notes:"
          Get-Content release-notes.txt
      
      - name: Create archive of module version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $sourceDir = "Datto.DBPool.API/$version"
          $zipName = "Datto.DBPool.API-$version.zip"
          
          if (Test-Path $sourceDir) {
              Compress-Archive -Path $sourceDir -DestinationPath $zipName -Force
              Write-Host "✅ Created: $zipName"
              
              # Verify archive contents
              $archiveContents = Get-ChildItem $sourceDir -Recurse | Measure-Object
              Write-Host "Archive contains $($archiveContents.Count) files"
          } else {
              Write-Error "❌ Build output directory not found: $sourceDir"
              Write-Host "Available directories:"
              Get-ChildItem -Directory | Select-Object Name
              exit 1
          }
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body_path: release-notes.txt
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./Datto.DBPool.API-${{ steps.version.outputs.version }}.zip
          asset_name: Datto.DBPool.API-${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip
