name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.2.3, v1.0.0

jobs:
  # Step 1: Run CI to ensure all checks pass before release
  ci:
    name: CI - Verify Code Quality
    uses: ./.github/workflows/ci.yml

  # Step 2: Only proceed with release if CI passes
  build-and-release:
    name: Create Release
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For creating releases and tags
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log and tags

      - name: Determine version source
        id: version-source
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -like "refs/tags/v*") {
              $tagVersion = "${{ github.ref }}" -replace 'refs/tags/v', ''
              Write-Output "source=tag" >> $env:GITHUB_OUTPUT
              Write-Output "tag_version=$tagVersion" >> $env:GITHUB_OUTPUT
              Write-Host "✅ Triggered by tag: v$tagVersion"
          } else {
              Write-Output "source=manual" >> $env:GITHUB_OUTPUT
              Write-Host "✅ Triggered manually"
          }

      - name: Setup PowerShell
        shell: pwsh
        run: |
          pwsh -v

      - name: Bootstrap and build module
        shell: pwsh
        run: |
          ./build.ps1 -Bootstrap

      - name: Extract version from CHANGELOG
        id: version
        shell: pwsh
        run: |
          $changelogPath = './CHANGELOG.md'
          $changelogTagMatchRegEx = "^##\s\[(?<Version>(\d+\.){1,3}\d+)\]"
          $version = Get-Content $changelogPath | ForEach-Object {
              if ($_ -match $changelogTagMatchRegEx) {
                  return $matches.Version
              }
          } | Select-Object -First 1

          if (-not $version) {
              Write-Error "Could not extract version from CHANGELOG.md"
              exit 1
          }

          Write-Output "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "✅ Extracted CHANGELOG version: $version"

          # If triggered by tag, validate tag matches CHANGELOG
          $tagVersion = "${{ steps.version-source.outputs.tag_version }}"
          if ("${{ steps.version-source.outputs.source }}" -eq "tag" -and $tagVersion) {
              if ($tagVersion -ne $version) {
                  Write-Error @"
          ❌ Git tag version mismatch!
             Git tag version:      $tagVersion
             CHANGELOG version:    $version

             The git tag must match the version in CHANGELOG.md
             Please ensure versions are synchronized before tagging.
          "@
                  exit 1
              }
              Write-Host "✅ Git tag matches CHANGELOG version"
          }

      - name: Get previous release tag
        id: previous-tag
        shell: pwsh
        run: |
          $tag = & git describe --tags --abbrev=0 2>$null
          if ($tag) {
              Write-Output "tag=$tag" >> $env:GITHUB_OUTPUT
              Write-Host "Previous release tag: $tag"
          } else {
              Write-Output "tag=" >> $env:GITHUB_OUTPUT
              Write-Host "No previous release found (first release)"
          }

      - name: Validate version has changed
        shell: pwsh
        run: |
          $currentVersion = "${{ steps.version.outputs.version }}"
          $previousTag = "${{ steps.previous-tag.outputs.tag }}"

          if ($previousTag) {
              # Remove 'v' prefix if present for comparison
              $previousVersion = $previousTag -replace '^v', ''

              if ($previousVersion -eq $currentVersion) {
                  Write-Error @"
          ❌ Version has not changed since last release!
             Current version: $currentVersion
             Last released:   $previousVersion

             Please update the version in:
             - CHANGELOG.md (add new section with format: ## [X.Y.Z] Release)
             - src/Datto.DBPool.API.psd1 (update ModuleVersion)

             The Pester tests validate these match before publishing.
          "@
                  exit 1
              }

              Write-Host "✅ Version updated: $previousVersion → $currentVersion"
          } else {
              Write-Host "✅ First release with version: $currentVersion"
          }

      - name: Generate release notes
        id: release-notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $changelogPath = './CHANGELOG.md'

          # Extract release notes from CHANGELOG for this version
          $inVersionSection = $false
          $releaseNotes = @()
          $versionPattern = "^##\s\[$version\]"
          $nextVersionPattern = "^##\s\["

          Get-Content $changelogPath | ForEach-Object {
              if ($_ -match $versionPattern) {
                  $inVersionSection = $true
                  return  # Skip the version header line
              }

              if ($inVersionSection) {
                  # Stop when we hit the next version section
                  if ($_ -match $nextVersionPattern) {
                      $inVersionSection = $false
                      return
                  }

                  # Skip empty lines at the start
                  if (-not $releaseNotes -and [string]::IsNullOrWhiteSpace($_)) {
                      return
                  }

                  $releaseNotes += $_
              }
          }

          # If no CHANGELOG notes found, fall back to git log
          if (-not $releaseNotes) {
              Write-Host "[WARN] No release notes found in CHANGELOG for version $version, using git log"
              $previousTag = "${{ steps.previous-tag.outputs.tag }}"

              if ($previousTag) {
                  $gitNotes = & git log "${previousTag}..HEAD" --pretty=format:"- %s (%h)" --no-merges
                  if ($gitNotes) {
                      $releaseNotes = @("## Changes since $previousTag", "") + $gitNotes
                  } else {
                      $releaseNotes = @("No changes recorded")
                  }
              } else {
                  $releaseNotes = @("First release")
              }
          }

          $fullNotes = $releaseNotes -join "`n"
          $fullNotes = $fullNotes.TrimEnd()

          $fullNotes | Out-File -FilePath release-notes.txt -Encoding utf8
          Write-Host "[INFO] Release notes:"
          Write-Host "---------------------"
          Get-Content release-notes.txt
          Write-Host "---------------------"

      - name: Create archive of module version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $sourceDir = "Datto.DBPool.API/$version"
          $zipName = "Datto.DBPool.API-$version.zip"

          if (Test-Path $sourceDir) {
              Compress-Archive -Path $sourceDir -DestinationPath $zipName -Force
              Write-Host "[SUCCESS] Created: $zipName"

              # Verify archive contents
              $archiveContents = Get-ChildItem $sourceDir -Recurse | Measure-Object
              Write-Host "Archive contains $($archiveContents.Count) files"
          } else {
              Write-Error "[ERROR] Build output directory not found: $sourceDir"
              Write-Host "Available directories:"
              Get-ChildItem -Directory | Select-Object Name
              exit 1
          }

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body_path: release-notes.txt
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ./Datto.DBPool.API-${{ steps.version.outputs.version }}.zip
          tag_name: v${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger documentation build
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'Build_DocsSite.yml',
              ref: 'main'
            });
            core.info('[SUCCESS] Triggered documentation build');
